/***************************************************************************
 *
 *  File:  main.c
 *
 *  Program to demonstrate the DSP point-transformation program PTTRANS.
 *
 ***************************************************************************/

#include	"sgl.h"
#include	"sega_int.h"
#include	"sega_dsp.h"

/*
 *  Here's the array that holds the DSP program.
 */
unsigned long DSPProgram[] = {
#include "pttrans.d"
};

/*
 *  Here's the transformation matrix we'll use.
 */
unsigned long	Matrix[12] =
		{
			0x10000, 0x20000, 0x30000, 0x40000,
			0x50000, 0x60000, 0x70000, 0x80000,
			0x90000, 0xa0000, 0xb0000, 0xc0000
		};

/*
 *  Here's a set of test input data.
 */
unsigned long	InputPts[128*3] =
		{
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000,
			0x10000, 0x20000, 0x30000, 0x30000, 0x20000, 0x10000
		};

/*
 *  Here's a buffer in which to store the transformed points.  If the
 *  given matrix and input points are used, then the output points should
 *  be (0x12, 0x2e, 0x4a) and (0xe, 0x2a, 0x46) repeated over and over.
 */
unsigned long	OutputPts[128*3];

/*
 *  Here's where we put the paramter block that tells the DSP program where
 *  to find its inputs and where to store its outputs.
 */
unsigned long	DSPParams[4];

__main()
{
}

void main()
{
	slInitSystem(TV_320x224, NULL, 1);

	/*
	 *  Initialize the parameter block.
	 */
	DSPParams[0] = ((unsigned long) Matrix) >> 2;
	DSPParams[1] = 128;
	DSPParams[2] = ((unsigned long) InputPts) >> 2;
	DSPParams[3] = ((unsigned long) OutputPts) >> 2;

	/*
	 *  Send the program, then the parameters, then run the program.
	 */
	DSP_LoadProgram(0, DSPProgram, 0x47);
	DSP_WriteData(0, DSPParams, 4);
	DSP_Start(0);

	/*
	 *  Wait for the DSP program to complete.
	 */
	while (! (*((volatile Uint32 *) 0x25fe00a4) & 0x20))
		;
	*((Uint32 *) 0x25fe00a4) = ~0x20;

	while (! (*((volatile Uint32 *) 0x25fe0080) & 0x40000))
		;

	/*
	 *  For good measure.
	 */
	DSP_Stop();

	while(1){}
}
